#!/usr/bin/env bash

_user="$(who|awk 'NR==1 {print $1}')"
installdrv=$(df -hT | grep /$ | cut -d " " -f 1)
timestamp=$(date +"%Y-%m-%d-%H%M")
cd /

filetorestore=$(su -g wheel $_user -c 'yad --file --title="Select backup to restore" --width=780 --height=440')
lsblk -dno MODEL,SIZE,TRAN,NAME,MOUNTPOINT
echo ""
echo "Select target drive then target partition"
read -p "Target drive: " targetdrive
read -p "Target partition: " targetpartition

echo ""
echo "Setting up target device.."; sleep 2
echo ""
mkdir /mnt/restore-$timestamp

# If you want a clean slate and a single ext4 partition
#wipefs --all --force /dev/$targetdrive
#parted /dev/$targetdrive mklabel msdos --script
#parted /dev/$targetdrive mkpart primary ext4 0% 100% --script
#parted /dev/$targetdrive align-check optimal 1

#mkfs.ext4 -F /dev/$targetdrive$targetpartition
parted /dev/"$targetdrive" set 1 boot on
tune2fs -L vx_live /dev/$targetdrive$targetpartition
echo ""

echo "Transferring to target"; sleep 2
mount /dev/$targetdrive$targetpartition /mnt/restore-$timestamp
tar -xpvf $filetorestore -C /mnt/restore-$timestamp --numeric-owner

echo ""
echo "Syncing.."
echo "Takes a while for USB.."
sync
echo "Syncing complete"
echo ""

# Restore GRUB
echo "Restoring GRUB.."
olduuid=$(cat /mnt/restore-$timestamp/olduuid)
newuuid=$(findmnt /mnt/restore-$timestamp -o UUID -n)
targetfs=$(lsblk -f /dev/$targetdrive$targetpartition | awk {'print $2'} | tail -n +2)
grub-install --root-directory=/mnt/restore-$timestamp /dev/$targetdrive
echo "$newuuid" > /mnt/restore-$timestamp/newuuid
echo "UUID=$newuuid / ${targetfs} defaults,noatime 0 1" > /mnt/restore-$timestamp/etc/fstab
echo "tmpfs /tmp tmpfs defaults,nosuid,nodev 0 0" >> /mnt/restore-$timestamp/etc/fstab
sed -i "s/$olduuid/$newuuid/g" /mnt/restore-$timestamp/boot/grub/grub.cfg
sync
echo ""

echo "Unmounting target.."
umount /mnt/restore-$timestamp
update-grub
echo ""

echo "Restore complete"
echo ""
sleep 5
exit
